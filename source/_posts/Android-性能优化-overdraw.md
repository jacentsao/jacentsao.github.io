---
title: Android-性能优化-overdraw
date: 2017-08-22 23:15:59
tags: [Android, Performance]
categories: Android
---

现在项目的性能之差令人发指，其实主要原因在于：

1. 开发人员本身能力有限，同时架构闻所未闻，见所未见。总而言之，搞不定。
2. 产品设计从来都是乱搞，没有整体性的设计(感觉我们的app真是业界毒瘤之典范)

不过，我们还是要把能做好的做好了才行。

### 性能优化-OverDraw
所谓**[overdraw](https://developer.android.com/topic/performance/rendering/overdraw.html)**(过度绘制)就是在一个点上进行了超过一次的绘制。过渡绘制是无意义的，需要我们去优化的，它会浪费GPU资源去渲染一些用户不可见的无意义的图层。关于如何查看过渡绘制，应该都是有所了解的。接下来是关于过度绘制：过度绘制是什么，怎么诊断过度绘制，你该采取何种方式取消除或者减轻过渡绘制。

#### 理解过度绘制

过渡绘制指的是系统在一个像素点是那个进行了多次的渲染。例如，我们一些堆叠的UI卡片，每一张卡片又隐藏了它的一部分。

当然，系统仍然需要绘制这叠卡片的隐藏部分，因为卡片的绘制是根据[画家算法](https://zh.wikipedia.org/wiki/%E7%94%BB%E5%AE%B6%E7%AE%97%E6%B3%95)（**“画家算法”表示头脑简单的画家首先绘制距离较远的场景，然后用绘制距离较近的场景覆盖较远的部分。**）。这就是从下到上的顺序。这种渲染顺序允许系统增加合适的透明度给半透明的物体，例如阴影。

#### 查找过度绘制

Android提供了几种工具帮助你查找影响到你的app性能的过度绘制。这些工具在你的设备上打开**开发者模式**就可以找到。关于更多开发者选项，可以参见[Run Apps on a Hardware Device](https://developer.android.com/studio/run/device.html#developer-device-options)。

#### 调试GPU过度绘制工具

调试GPU过度绘制工具使用颜色来代表你的应用在一个像素点上渲染的次数。渲染次数越多，过度绘制就越会影响你的应用性能。

关于如何使用这些工具，请继续往下看：

##### 调试GPU过度绘制查验

这种检查方法是通过颜色来形象化手机中的过度绘制，有如下好处：

* 显现出应用做了哪些无用的渲染工作
* 帮助你找到可能能够减少渲染的天花板

在开发者选项 - 调试GPU过度绘制 - 选用显示过度绘制区域，然后回到你的应用，这时候你看到的颜色

* 原色：没有过度绘制
* 蓝色：一次过度绘制
* 绿色： 两次过度绘制
* 粉红色： 三次过度绘制
* 红色：四次或者四次以上的过度绘制


![](https://developer.android.com/images/tools/performance/debug-gpu-overdraw/gettingstarted_image03.png) 

有时候过度绘制是不可避免的。当你调试你的UI的时候，你的界面应该尽量是原色或者蓝色。

##### GPU呈现模式分析

GPU呈现模式会在屏幕显示一个滚动的柱状图，每一个长方形都代表一帧的绘制

在一些低性能的GPU设备上，GPU填满帧缓存区的速度会变得很慢。当很多像素需要绘制的时候，GPU需要花很长的时间来执行新的命令，这就会导致系统对于其它的请求反应变得很慢。

#### 优化过度绘制

1. 减少不必要的背景
2. 扁平化布局，减少布局的层次
3. 少使用transparency属性

##### 减少不必要的背景

布局本身是没有背景的，这就意味着他本身并不需要渲染背景。当布局本身有了背景以后，就意味着她可能会导致过度绘制。

移除不必要的背景是一种快速修复渲染问题的手段。当绘制的背景对于用户来说完全不可见的时候就可以取移除掉这些背景了。例如一个设置了背景色的app，那么定义在Activity中的任意一个容易本身是不需要背景的。

如果需要知道为什么你的app会出现过度绘制，你可以使用[Hierarchy View](https://developer.android.com/studio/profile/hierarchy-viewer.html)工具。当你使用这个工具的时候，消除所有对于用户不可见的背景。当然，我们可以通过设置一个通用的背景来达到消除不必要的背景的目的，这样子绘制的容器就可以不再定义自己的背景而使用app的通用背景（windowbackgroud）。

##### 减少布局的层次

不局的过多嵌套同样也会导致过度绘制，同时也会因为节点过深导致视图的加载变慢。我们应该减少UI的重叠绘制，详情参见[Optimizing View Hierarchies](https://developer.android.com/topic/performance/optimizing-view-hierarchies.html)

##### 使用transparency

使用Alpha值的时候，同捕鱼常规的过度绘制即在同一像素点多次绘制，transparent属性的对象首先需要已经存在的像素进行绘制，然后进行等价的混合。例如，一个黑色字体的TextView通过添加Alpha值来达到灰色的效果，当然这个时候可以直接使用灰色来替换。 transparent animations, fade-outs, 以及 drop shadows以及其他的半透明效果，都会显著导致过度绘制。


